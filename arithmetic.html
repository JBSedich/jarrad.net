<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arithmetic Trainer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeOut {
      0% { opacity: 0.5; }
      70% { opacity: 0.5; }
      100% { opacity: 0; }
    }
    .animate-fade-out {
      animation: fadeOut 2s ease-out forwards;
    }
  </style>
</head>
<body class="bg-gray-900">
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    const BACKGROUND_EMOJIS = [
      'ğŸª', 'ğŸï¸', 'ğŸŒ»', 'ğŸŒº', 'ğŸµï¸', 'ğŸŒ¸', 'ğŸ–ï¸', 'ğŸŒ‹', 'ğŸœï¸', 'ğŸ°',
      'ğŸ«', 'ğŸ§­', 'ğŸ”ï¸', 'â›º', 'ğŸ›', 'ğŸ ', 'ğŸŒ…', 'ğŸŒ„', 'â­', 'â›…',
      'âš¡', 'â„ï¸', 'ğŸŒˆ', 'ğŸ¦–', 'ğŸ¦â€ğŸ”¥', 'ğŸ²', 'ğŸ¦ˆ', 'ğŸ¦‹', 'ğŸ¦”', 'ğŸ¦š', 'ğŸ¦‰'
    ];

    function hashProblem(display) {
      let hash = 0;
      for (let i = 0; i < display.length; i++) {
        hash = ((hash << 5) - hash) + display.charCodeAt(i);
        hash = hash & hash;
      }
      return Math.abs(hash) % BACKGROUND_EMOJIS.length;
    }

    function parseConfig(input) {
      const config = {
        operations: [],
        timer: null,
        errors: [],
      };

      if (!input.trim()) {
        config.operations.push({ op: '*', min: 2, max: 12 });
        return config;
      }

      const defaults = {
        '+': [1, 100],
        '-': [1, 100],
        '*': [2, 12],
        '/': [2, 12],
        '//': [2, 12],
      };

      const normalized = input.trim().replace(/\s+/g, ' ');
      const tokenPattern = /(\/\/\[?\d+,\d+\]?|\/\/\[?\d+\]?|\/\/|\/\[?\d+,\d+\]?|\/\[?\d+\]?|\/|[+\-*]\[?\d+,\d+\]?|[+\-*]\[?\d+\]?|[+\-*]|t\[?\d+\]?)/gi;
      const tokens = normalized.match(tokenPattern) || [];
      
      const defaultMin = {
        '+': 1,
        '-': 1,
        '*': 2,
        '/': 2,
        '//': 2,
      };
      
      const matched = tokens.join('');
      const stripped = normalized.replace(/\s/g, '');
      if (matched.toLowerCase() !== stripped.toLowerCase() && stripped.length > 0) {
        let remaining = stripped.toLowerCase();
        for (const token of tokens) {
          remaining = remaining.replace(token.toLowerCase(), '');
        }
        if (remaining) {
          config.errors.push(`Couldn't parse: "${remaining}"`);
        }
      }

      for (const token of tokens) {
        const timerMatch = token.match(/^t\[?(\d+)\]?$/i);
        if (timerMatch) {
          config.timer = parseInt(timerMatch[1], 10);
          continue;
        }

        const opRangeMatch = token.match(/^(\/\/|[+\-*/])\[?(\d+),(\d+)\]?$/);
        if (opRangeMatch) {
          const [, op, minStr, maxStr] = opRangeMatch;
          const min = parseInt(minStr, 10);
          const max = parseInt(maxStr, 10);
          if (min > max) {
            config.errors.push(`Invalid range: ${min} > ${max}`);
            continue;
          }
          config.operations.push({
            op: op === '//' ? 'remainder' : op === '/' ? 'divide' : op,
            min,
            max,
          });
          continue;
        }

        const opSingleMatch = token.match(/^(\/\/|[+\-*/])\[?(\d+)\]?$/);
        if (opSingleMatch) {
          const [, op, maxStr] = opSingleMatch;
          const max = parseInt(maxStr, 10);
          const min = defaultMin[op];
          config.operations.push({
            op: op === '//' ? 'remainder' : op === '/' ? 'divide' : op,
            min,
            max,
          });
          continue;
        }

        const opMatch = token.match(/^(\/\/|[+\-*/])$/);
        if (opMatch) {
          const op = opMatch[1];
          const [min, max] = defaults[op];
          config.operations.push({
            op: op === '//' ? 'remainder' : op === '/' ? 'divide' : op,
            min,
            max,
          });
          continue;
        }
      }

      if (config.operations.length === 0 && config.timer === null && !config.errors.length) {
        config.errors.push(`Couldn't understand input`);
      }

      if (config.operations.length === 0 && config.timer !== null) {
        config.operations.push({ op: '*', min: 2, max: 12 });
      }

      return config;
    }

    function generateProblem(operations) {
      const opConfig = operations[Math.floor(Math.random() * operations.length)];
      const { op, min, max } = opConfig;

      let a, b, answer, display, answerFormat;

      switch (op) {
        case '+':
          a = Math.floor(Math.random() * (max - min + 1)) + min;
          b = Math.floor(Math.random() * (max - min + 1)) + min;
          answer = String(a + b);
          display = `${a} + ${b}`;
          answerFormat = 'number';
          break;

        case '-':
          a = Math.floor(Math.random() * (max - min + 1)) + min;
          b = Math.floor(Math.random() * (max - min + 1)) + min;
          if (b > a) [a, b] = [b, a];
          answer = String(a - b);
          display = `${a} âˆ’ ${b}`;
          answerFormat = 'number';
          break;

        case '*':
          a = Math.floor(Math.random() * (max - min + 1)) + min;
          b = Math.floor(Math.random() * (max - min + 1)) + min;
          answer = String(a * b);
          display = `${a} Ã— ${b}`;
          answerFormat = 'number';
          break;

        case 'divide':
          a = Math.floor(Math.random() * (max - min + 1)) + min;
          b = Math.floor(Math.random() * (max - min + 1)) + min;
          answer = String(b);
          display = `${a * b} Ã· ${a}`;
          answerFormat = 'number';
          break;

        case 'remainder':
          a = Math.floor(Math.random() * (max - min + 1)) + min;
          const maxDividend = a * max; 
          const dividend = Math.floor(Math.random() * maxDividend) + 1;
          const quotient = Math.floor(dividend / a);
          const remainder = dividend % a;
          answer = remainder === 0 ? String(quotient) : `${quotient}r${remainder}`;
          display = `${dividend} Ã· ${a}`;
          answerFormat = 'remainder';
          break;

        default:
          a = 2; b = 2; answer = '4'; display = '2 Ã— 2'; answerFormat = 'number';
      }

      return { display, answer, answerFormat };
    }

    function normalizeAnswer(input, format) {
      const cleaned = input.trim().toLowerCase().replace(/\s+/g, '');
      return cleaned;
    }

    const DEFAULT_SAVED_GAMES = [
      { config: '*1,12 t120', name: 'Times tables (2min)' },
      { config: '+1,20 -1,20 t120', name: 'Number bonds to 20 (2min)' },
      { config: '+1,30 -1,30 *1,5 /1,5 t300', name: 'Basic mixed (5min)' },
      { config: '+1,99 -1,99 *1,12 /1,12 t300', name: 'Mixed (5min)' },
      { config: '+100,999', name: '3 digit mental math #1' },
      { config: '+100,999 -100,999', name: '3 digit mental math #2' },
    ];

    function ArithmeticTrainer() {
      const [phase, setPhase] = useState('config');
      const [configInput, setConfigInput] = useState('');
      const [config, setConfig] = useState(null);
      const [problem, setProblem] = useState(null);
      const [userAnswer, setUserAnswer] = useState('');
      const [timeLeft, setTimeLeft] = useState(null);
      const [stats, setStats] = useState({ attempted: 0, correct: 0 });
      const [configError, setConfigError] = useState('');
      const [mode, setMode] = useState('speed');
      const [wrongAnswer, setWrongAnswer] = useState(null);
      const [showEmoji, setShowEmoji] = useState(false);
      const [examplesExpanded, setExamplesExpanded] = useState(false);
      const [howItWorksExpanded, setHowItWorksExpanded] = useState(false);
      const [savedGamesExpanded, setSavedGamesExpanded] = useState(true);
      const [savedGames, setSavedGames] = useState([]);
      const [saveName, setSaveName] = useState('');
      const [showSaveInput, setShowSaveInput] = useState(false);
      const [showRestoreConfirm, setShowRestoreConfirm] = useState(false);
      
      const inputRef = useRef(null);
      const timerRef = useRef(null);

      const startPractice = useCallback(() => {
        const parsed = parseConfig(configInput);
        
        if (parsed.errors.length > 0) {
          setConfigError(parsed.errors.join('. '));
          return;
        }
        
        setConfigError('');
        setConfig(parsed);
        setStats({ attempted: 0, correct: 0 });
        setProblem(generateProblem(parsed.operations));
        setUserAnswer('');
        setTimeLeft(parsed.timer);
        setWrongAnswer(null);
        setPhase('practice');
      }, [configInput]);

      const nextProblem = useCallback(() => {
        if (config) {
          setProblem(generateProblem(config.operations));
          setUserAnswer('');
        }
      }, [config]);

      const endSession = useCallback(() => {
        if (timerRef.current) {
          clearInterval(timerRef.current);
          timerRef.current = null;
        }
        setPhase('results');
      }, []);

      // Load saved games from localStorage on mount
      useEffect(() => {
        try {
          const stored = localStorage.getItem('arithmeticTrainerSavedGames');
          if (stored) {
            setSavedGames(JSON.parse(stored));
          } else {
            setSavedGames(DEFAULT_SAVED_GAMES);
            localStorage.setItem('arithmeticTrainerSavedGames', JSON.stringify(DEFAULT_SAVED_GAMES));
          }
        } catch (e) {
          setSavedGames(DEFAULT_SAVED_GAMES);
        }
      }, []);

      const saveGame = (name) => {
        if (!configInput.trim() || !name.trim()) return;
        
        const parsed = parseConfig(configInput.trim());
        if (parsed.errors.length > 0) {
          setConfigError(parsed.errors.join('. '));
          return;
        }
        
        const newGame = { name: name.trim(), config: configInput.trim() };
        const updated = [...savedGames, newGame];
        setSavedGames(updated);
        setShowSaveInput(false);
        setSaveName('');
        
        try {
          localStorage.setItem('arithmeticTrainerSavedGames', JSON.stringify(updated));
        } catch (e) {}
      };

      const deleteGame = (index) => {
        const updated = savedGames.filter((_, i) => i !== index);
        setSavedGames(updated);
        
        try {
          localStorage.setItem('arithmeticTrainerSavedGames', JSON.stringify(updated));
        } catch (e) {}
      };

      const restoreDefaults = () => {
        setSavedGames(DEFAULT_SAVED_GAMES);
        try {
          localStorage.setItem('arithmeticTrainerSavedGames', JSON.stringify(DEFAULT_SAVED_GAMES));
        } catch (e) {}
      };

      const loadGame = (config) => {
        setConfigInput(config);
        setConfigError('');
      };

      useEffect(() => {
        if (phase === 'practice' && inputRef.current) {
          inputRef.current.focus();
        }
      }, [phase, problem]);

      useEffect(() => {
        if (phase !== 'practice') return;
        
        const handleGlobalKeyDown = (e) => {
          if (e.key === 'q' || e.key === 'Q') {
            e.preventDefault();
            endSession();
          }
        };
        
        document.addEventListener('keydown', handleGlobalKeyDown);
        return () => document.removeEventListener('keydown', handleGlobalKeyDown);
      }, [phase, endSession]);

      useEffect(() => {
        if (phase === 'practice' && timeLeft !== null && timeLeft > 0) {
          timerRef.current = setInterval(() => {
            setTimeLeft(prev => {
              if (prev <= 1) {
                clearInterval(timerRef.current);
                timerRef.current = null;
                setPhase('results');
                return 0;
              }
              return prev - 1;
            });
          }, 1000);
          return () => {
            if (timerRef.current) {
              clearInterval(timerRef.current);
            }
          };
        }
      }, [phase, timeLeft !== null]);

      const handleAnswerChange = (e) => {
        const value = e.target.value;
        
        if (value.toLowerCase().includes('q')) {
          return;
        }
        
        setUserAnswer(value);

        if (mode === 'speed' && problem && value.trim()) {
          const normalized = normalizeAnswer(value, problem.answerFormat);
          const correct = normalizeAnswer(problem.answer, problem.answerFormat);
          
          if (normalized === correct) {
            setStats(prev => ({
              attempted: prev.attempted + 1,
              correct: prev.correct + 1,
            }));
            nextProblem();
          }
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && userAnswer.trim()) {
          e.preventDefault();
          
          const normalized = normalizeAnswer(userAnswer, problem.answerFormat);
          const correct = normalizeAnswer(problem.answer, problem.answerFormat);
          const isCorrect = normalized === correct;
          
          if (mode === 'tally') {
            if (isCorrect) {
              setStats(prev => ({
                attempted: prev.attempted + 1,
                correct: prev.correct + 1,
              }));
              nextProblem();
            } else {
              setStats(prev => ({
                attempted: prev.attempted + 1,
                correct: prev.correct,
              }));
              setUserAnswer('');
            }
          } else if (mode === 'test') {
            if (isCorrect) {
              setStats(prev => ({
                attempted: prev.attempted + 1,
                correct: prev.correct + 1,
              }));
            } else {
              setStats(prev => ({
                attempted: prev.attempted + 1,
                correct: prev.correct,
              }));
              setWrongAnswer({ answer: problem.answer, key: Date.now() });
            }
            nextProblem();
          }
        }
      };

      const handleConfigKeyDown = (e) => {
        if (e.key === 'Enter') {
          startPractice();
        }
      };

      const formatTime = (seconds) => {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return m > 0 ? `${m}:${s.toString().padStart(2, '0')}` : `${s}s`;
      };

      // CONFIG PHASE
      if (phase === 'config') {
        return (
          <div className="min-h-screen bg-gray-900 text-gray-100 flex items-center justify-center p-6 overflow-hidden">
            <div 
              className="absolute inset-0 flex items-center justify-center pointer-events-none select-none"
              style={{ fontSize: '40rem', opacity: 0.07 }}
            >
              ğŸŒ
            </div>
            
            <div className="w-full max-w-lg relative">
              <h1 className="text-2xl font-semibold mb-2 text-center">Arithmetic Trainer</h1>
              <p className="text-gray-400 text-sm text-center mb-6">
                Highly configurable, fast-paced retrieval practice.
              </p>
              
              <div className="bg-gray-800 border border-gray-700 rounded-lg p-4 mb-4">
                <p className="text-sm text-gray-300 mb-3">
                  Enter your configuration (or press Enter for defaults):
                </p>
                <input
                  type="text"
                  value={configInput}
                  onChange={(e) => { setConfigInput(e.target.value); setConfigError(''); }}
                  onKeyDown={handleConfigKeyDown}
                  placeholder="e.g., +1,100 *12 t60"
                  className={`w-full px-4 py-3 bg-gray-900 border rounded-lg focus:outline-none text-gray-100 placeholder-gray-500 font-mono ${configError ? 'border-red-500' : 'border-gray-600 focus:border-blue-500'}`}
                  autoFocus
                />
                {configError && (
                  <p className="mt-2 text-sm text-red-400">{configError}</p>
                )}
                
                <div className="flex mt-4 bg-gray-900 rounded-lg p-1">
                  <button
                    onClick={() => setMode('speed')}
                    className={`flex-1 px-3 py-2 rounded-md text-sm font-medium transition-colors ${mode === 'speed' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-gray-200'}`}
                  >
                    Speed
                  </button>
                  <button
                    onClick={() => setMode('tally')}
                    className={`flex-1 px-3 py-2 rounded-md text-sm font-medium transition-colors ${mode === 'tally' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-gray-200'}`}
                  >
                    Tally
                  </button>
                  <button
                    onClick={() => setMode('test')}
                    className={`flex-1 px-3 py-2 rounded-md text-sm font-medium transition-colors ${mode === 'test' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-gray-200'}`}
                  >
                    Test
                  </button>
                </div>
                <p className="mt-2 text-xs text-gray-500">
                  {mode === 'speed' && "Advances instantly on correct answer, no [enter â†µ] button required. Doesn't track incorrect answers (just total)."}
                  {mode === 'tally' && 'Tracks correct answers to total answers. Retry each until correct.'}
                  {mode === 'test' && 'Tracks correct answers to total answers. One attempt at each.'}
                </p>
                
                <label className="flex items-center gap-2 mt-4 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={showEmoji}
                    onChange={(e) => setShowEmoji(e.target.checked)}
                    className="w-4 h-4 rounded bg-gray-900 border-gray-600"
                  />
                  <span className="text-sm text-gray-400">Unique background for each question</span>
                </label>
                
                <button
                  onClick={startPractice}
                  className="mt-3 w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition-colors"
                >
                  Start
                </button>
              </div>

              <div className="text-xs text-gray-500 space-y-2">
                <button 
                  onClick={() => setHowItWorksExpanded(!howItWorksExpanded)}
                  className="text-gray-400 font-medium flex items-center gap-1 hover:text-gray-300 transition-colors"
                >
                  <span className={`transition-transform ${howItWorksExpanded ? 'rotate-90' : ''}`}>â–¶</span>
                  How it works
                </button>
                
                {howItWorksExpanded && (
                  <p className="pl-4">Use <span className="font-mono text-gray-400">+</span> <span className="font-mono text-gray-400">-</span> <span className="font-mono text-gray-400">*</span> <span className="font-mono text-gray-400">/</span> for operations, or <span className="font-mono text-gray-400">//</span> for division with remainders. Add a number after any operator to set the max (e.g. <span className="font-mono text-gray-400">*12</span>), or two numbers with a comma for min and max (e.g. <span className="font-mono text-gray-400">+10,50</span>). Add <span className="font-mono text-gray-400">t</span> followed by seconds for a timer. Combine as many as you like, separated by spaces.</p>
                )}
                
                <button 
                  onClick={() => setExamplesExpanded(!examplesExpanded)}
                  className="text-gray-400 font-medium mt-1 flex items-center gap-1 hover:text-gray-300 transition-colors"
                >
                  <span className={`transition-transform ${examplesExpanded ? 'rotate-90' : ''}`}>â–¶</span>
                  Examples
                </button>
                
                {examplesExpanded && (
                  <div className="pl-4 space-y-2">
                    <p className="text-gray-400 italic mt-2">Ranges</p>
                    <p className="font-mono text-gray-100 bg-gray-800 border border-gray-700 rounded px-2 py-1 inline-block">+100,999 *2,14</p>
                    <p>Addition from 100+100 to 999+999, and multiplication from 2Ã—2 to 14Ã—14</p>
                    
                    <p className="text-gray-400 italic mt-2">Max of range</p>
                    <p className="font-mono text-gray-100 bg-gray-800 border border-gray-700 rounded px-2 py-1 inline-block">*8 /6</p>
                    <p>Times tables up to 8 and division up to 6</p>
                    
                    <p className="text-gray-400 italic mt-2">Just operators</p>
                    <p className="font-mono text-gray-100 bg-gray-800 border border-gray-700 rounded px-2 py-1 inline-block">+ - *</p>
                    <p>Addition, subtraction and multiplication with defaults (+ and - use 1â€“100, * uses 2â€“12)</p>
                    
                    <p className="text-gray-400 italic mt-2">Timed game</p>
                    <p className="font-mono text-gray-100 bg-gray-800 border border-gray-700 rounded px-2 py-1 inline-block">* t60</p>
                    <p>Times tables, 60 second game</p>
                  </div>
                )}
                
                <button 
                  onClick={() => setSavedGamesExpanded(!savedGamesExpanded)}
                  className="text-gray-400 font-medium mt-1 flex items-center gap-1 hover:text-gray-300 transition-colors"
                >
                  <span className={`transition-transform ${savedGamesExpanded ? 'rotate-90' : ''}`}>â–¶</span>
                  Saved games
                </button>
                
                {savedGamesExpanded && (
                  <div className="pl-4 space-y-2 mt-2">
                    {savedGames.length === 0 ? (
                      <p className="text-gray-600 italic">No saved games yet</p>
                    ) : (
                      savedGames.map((game, index) => (
                        <div key={index} className="flex items-center gap-2">
                          <button
                            onClick={() => loadGame(game.config)}
                            className="font-mono text-gray-100 bg-gray-800 border border-gray-700 rounded px-2 py-1 hover:border-blue-500 transition-colors text-left"
                          >
                            {game.config}
                          </button>
                          <span className="text-gray-500">{game.name}</span>
                          <button
                            onClick={() => deleteGame(index)}
                            className="text-gray-600 hover:text-red-400 transition-colors ml-auto"
                          >
                            âœ•
                          </button>
                        </div>
                      ))
                    )}
                    
                    <div className="flex items-center justify-between mt-3">
                      <div>
                        {configInput.trim() && !showSaveInput && (
                          <button
                            onClick={() => setShowSaveInput(true)}
                            className="text-blue-400 hover:text-blue-300 transition-colors"
                          >
                            + Save current
                          </button>
                        )}
                      </div>
                      
                      {!showRestoreConfirm ? (
                        <button
                          onClick={() => setShowRestoreConfirm(true)}
                          className="text-blue-400 hover:text-blue-300 transition-colors"
                        >
                          Restore defaults
                        </button>
                      ) : (
                        <div className="flex items-center gap-2">
                          <span className="text-gray-400 text-xs">Replace all?</span>
                          <button
                            onClick={() => { restoreDefaults(); setShowRestoreConfirm(false); }}
                            className="text-red-400 hover:text-red-300"
                          >
                            Yes
                          </button>
                          <button
                            onClick={() => setShowRestoreConfirm(false)}
                            className="text-gray-500 hover:text-gray-400"
                          >
                            No
                          </button>
                        </div>
                      )}
                    </div>
                    
                    {showSaveInput && (
                      <div className="flex items-center gap-2 mt-2">
                        <input
                          type="text"
                          value={saveName}
                          onChange={(e) => setSaveName(e.target.value)}
                          onKeyDown={(e) => {
                            if (e.key === 'Enter') saveGame(saveName);
                            if (e.key === 'Escape') { setShowSaveInput(false); setSaveName(''); }
                          }}
                          placeholder="Name this game..."
                          className="px-2 py-1 bg-gray-800 border border-gray-600 rounded text-gray-100 text-xs focus:outline-none focus:border-blue-500"
                          autoFocus
                        />
                        <button
                          onClick={() => saveGame(saveName)}
                          className="text-blue-400 hover:text-blue-300"
                        >
                          Save
                        </button>
                        <button
                          onClick={() => { setShowSaveInput(false); setSaveName(''); }}
                          className="text-gray-500 hover:text-gray-400"
                        >
                          Cancel
                        </button>
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      // PRACTICE PHASE
      if (phase === 'practice') {
        const backgroundEmoji = showEmoji && problem 
          ? BACKGROUND_EMOJIS[hashProblem(problem.display)] 
          : 'ğŸª';
        
        return (
          <div className="min-h-screen bg-gray-900 text-gray-100 flex flex-col items-center justify-center p-6 overflow-hidden">
            <div 
              className="absolute inset-0 flex items-center justify-center pointer-events-none select-none"
              style={{ fontSize: '40rem', opacity: 0.07 }}
            >
              {backgroundEmoji}
            </div>
            
            {timeLeft !== null && (
              <div className="absolute top-6 right-6 text-2xl font-mono text-gray-400">
                {formatTime(timeLeft)}
              </div>
            )}
            
            <div className="absolute top-6 left-6">
              {mode === 'speed' ? (
                <>
                  <span className="text-5xl font-light text-white">{stats.correct}</span>
                  <span className="text-sm text-gray-500 ml-2">completed</span>
                </>
              ) : (
                <>
                  <span className="text-5xl font-light text-white">{stats.correct}/{stats.attempted}</span>
                  <span className="text-sm text-gray-500 ml-2">correct</span>
                </>
              )}
            </div>

            <div className="text-5xl font-light mb-8 tracking-wide">
              {problem?.display}
            </div>

            <div className="relative">
              <input
                ref={inputRef}
                type="text"
                value={userAnswer}
                onChange={handleAnswerChange}
                onKeyDown={handleKeyDown}
                className="w-32 text-center text-3xl px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 text-gray-100 font-mono"
                autoComplete="off"
                autoCorrect="off"
                autoCapitalize="off"
                spellCheck={false}
              />

              {wrongAnswer && (
                <p 
                  key={wrongAnswer.key}
                  className="absolute left-1/2 -translate-x-1/2 text-3xl text-red-500 opacity-50 animate-fade-out"
                  style={{ top: 'calc(100% + 50px)' }}
                  onAnimationEnd={() => setWrongAnswer(null)}
                >
                  {wrongAnswer.answer}
                </p>
              )}
            </div>

            <p className="mt-6 text-xs text-gray-600">
              {mode === 'speed' && 'Press Q to quit'}
              {mode === 'tally' && 'Press Q to quit â€¢ Enter to retry'}
              {mode === 'test' && 'Press Q to quit â€¢ Enter to submit'}
            </p>
          </div>
        );
      }

      // RESULTS PHASE
      if (phase === 'results') {
        const accuracy = stats.attempted > 0 
          ? Math.round((stats.correct / stats.attempted) * 100) 
          : 0;

        return (
          <div className="min-h-screen bg-gray-900 text-gray-100 flex items-center justify-center p-6 overflow-hidden">
            <div 
              className="absolute inset-0 flex items-center justify-center pointer-events-none select-none"
              style={{ fontSize: '40rem', opacity: 0.07 }}
            >
              ğŸ¦–
            </div>
            
            <div className="text-center relative">
              <h2 className="text-2xl font-semibold mb-6">Session Complete</h2>
              
              <div className="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                {mode === 'speed' ? (
                  <>
                    <div className="text-4xl font-light mb-2">{stats.correct}</div>
                    <div className="text-gray-400">completed</div>
                  </>
                ) : (
                  <>
                    <div className="text-4xl font-light mb-2">{stats.correct}/{stats.attempted}</div>
                    <div className="text-gray-400">correct answers</div>
                    <div className="text-2xl mt-3 text-blue-400">{accuracy}% accuracy</div>
                  </>
                )}
              </div>

              <div className="space-x-3">
                <button
                  onClick={() => {
                    setStats({ attempted: 0, correct: 0 });
                    setProblem(generateProblem(config.operations));
                    setUserAnswer('');
                    setTimeLeft(config.timer);
                    setWrongAnswer(null);
                    setPhase('practice');
                  }}
                  className="px-5 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition-colors"
                >
                  Restart
                </button>
                <button
                  onClick={() => {
                    setPhase('config');
                    setConfigInput('');
                  }}
                  className="px-5 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-medium transition-colors"
                >
                  Reconfigure
                </button>
              </div>
            </div>
          </div>
        );
      }

      return null;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<ArithmeticTrainer />);
  </script>
</body>
</html>
